---
title: "Bayesian mixture models for copy number estimation"
author: 
- Jacob Carey
- Robert Scharpf
- Steven Cristiano
date: \today
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Bayesian mixture models for copy number estimation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc} 
---

# Introduction

CNPBayes allows for copy number estimation via a Bayesian mixture model. Models
can be marginal or hierarchical over batches. The long-running, Markov Chain
Monte Carlo portions of the code are written in C++ (using Rcpp) for fast
performance.

# posteriorSimulation

In order to simulate the posterior distribution of a model, many parameters for
the routine must be specified first. An instance of class `McmcParams` is used
to specify the simulation options, such as number of iterations, length of
burnin, and thinning interval.
```{r McmcParams}
mp <- McmcParams(iter=1000,
                 burnin=100,
                 thin=1)
```

Hyperparameters for the mixture model are specified as an instance of class
`Hyperparameters`. Hyperparameters include: 
- `k` the number of components (or copy numbers). Defaults to 2. 
- `mu.0` and `tau2.0` priors for $\mu \sim \text{N(mu.0, tau2.0)}$, the 
  overall mean of components. Default to 0 and 100 respectively.
- `eta.0` and `m2.0` priors for 
  $\tau^2 \sim \text{Ga(rate=eta.0, shape=m2.0)}$, the overall variance across
  components. Default to 1 and 0.1 respectively for marginal models and 1800
  and 1/60 respectively for batch models.
- `alpha` the prior mixture probabilities. Does not have to sum to 1. By
  default, a noninformative prior of equal mixtures is used.
- `beta` prior for $\nu_0$. Defaults to 0.1.
- `a` and `b` priors for $\sigma^2_0 \sim \text{Ga(shape=a, rate=b)}$, the rate
  parameter for $\sigma^2$, the variance for each batch and component.

The type of model (batch or marginal) must also be specified when constructing
an instance of class `Hyperparameters`, as follows:
```{r Hyperparameters}
hypp.marginal <- Hyperparameters(type="marginal")
hypp.batch <- Hyperparameters(type="batch")
```

- graphical model

CNPBayes also allows for the simulation of test data. The number of
observations, means for each component, standard deviations for each component,
and mixture proportions must be specified. Additionally, for batch data, the
batch label for each observation must be specified as well.
```{r simulateData}
## Simulate data
sim.data <- simulateData(N=2500, p=rep(1/3, 3),
                         theta=c(-1, 0, 1),
                         sds=rep(0.1, 3))

## Simulate batch data
k <- 3
nbatch <- 3
means <- matrix(c(-1.2, -1.0, -0.8,
                -0.2, 0, 0.2,
                0.8, 1, 1.2), nbatch, k, byrow=FALSE)
sds <- matrix(0.1, nbatch, k)
N <- 1500
batch.sim.data <- simulateBatchData(N=N,
                                    batch=rep(letters[1:3], length.out=N),
                                    theta=means,
                                    sds=sds,
                                    p=c(1/5, 1/3, 1-1/3-1/5))
```

To simulate the posterior distribution, an instance of class MarginalModel or
BatchModel must first be constructed. Note that when initializing objects of
these classes, the parameters `data`, `k` (number of $a priori$ components), 
`hypp`, (object of class `Hyperparameters`) and `mcmc.params` (object of class
`McmcParams`) should be specified. Default values for `hypp` and `mcmc.params`
will be used if not specified. Note that to retrieve the simulated data from
the object, the `y` method can be used. After construction of a model, the
`posteriorSimulation` method should be used.

```{r model}
marginal.model <- MarginalModel(data=y(sim.data), k=3,
                                hypp=hypp.marginal,
                                mcmc.params=mp)

batch.model <- BatchModel(data=y(batch.sim.data), k=3,
                          batch=rep(letters[1:3], length.out=N),
                          hypp=hypp.batch,
                          mcmc.params=mp)

marginal.model <- posteriorSimulation(marginal.model)
batch.model <- posteriorSimulation(batch.model)
```

The results of the `posteriorSimulation` call returns an object of class
`DensityModel` or `DensityBatchModel`. This object can be used, along with the
data, for plotting.

```{r plot}
plot(DensityModel(marginal.model), y(sim.data), 
     main="Marginal Model posterior")
```
- merging (if needed)

# K unknown

Often times, the number of components is not known $a priori$.

- computeMarginalLik
    - Ref Chib estimator / Berkhof for estimating marginal likelihoods
- computing a bayes factor
- merging components
- Alternative statistics for model selection (i.e., BIC)

# Finding CNPs
- hidden Markov models
- prior knowledge (HapMap / 1000 Genomes Project)

# Other applications
- down-sampling 
- modeling differences in variance (same mean)
   - paramUpdates




