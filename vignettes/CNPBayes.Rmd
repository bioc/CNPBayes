---
title: "Bayesian mixture models for copy number estimation"
author: 
- Jacob Carey
- Robert Scharpf
- Steven Cristiano
date: \today
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Bayesian mixture models for copy number estimation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc} 
---

# Introduction

CNPBayes allows for copy number estimation via a Bayesian mixture model. Models
can be marginal or hierarchical over batches. The long-running, Markov Chain
Monte Carlo portions of the code are written in C++ (using Rcpp) for fast
performance.

```{r lib}
library(CNPBayes)
```

# posteriorSimulation

## MarginalModel
### McmcParams

In order to simulate the posterior distribution of a model, many parameters for
the routine must be specified first. An instance of class `McmcParams` is used
to specify the simulation options, such as number of iterations, length of
burnin, and thinning interval.
```{r McmcParams}
mp <- McmcParams(iter=1000,
                 burnin=100,
                 thin=1)
```

### Hyperparameters

Hyperparameters for the mixture model are specified as an instance of class
`Hyperparameters`. Hyperparameters include:  

- `k` the number of components (or copy numbers). Defaults to 2.  

- `mu.0` and `tau2.0` priors for $\mu \sim \text{N(mu.0, tau2.0)}$, the 
  overall mean of components. Default to 0 and 100 respectively.  

- `eta.0` and `m2.0` priors for 
  $\tau^2 \sim \text{Ga(rate=eta.0, shape=m2.0)}$, the overall variance across
  components. Default to 1 and 0.1 respectively for marginal models and 1800
  and 1/60 respectively for batch models.  

- `alpha` the prior mixture probabilities. Does not have to sum to 1. By
  default, a noninformative prior of equal mixtures is used.  

- `beta` prior for $\nu_0$. Defaults to 0.1.  

- `a` and `b` priors for $\sigma^2_0 \sim \text{Ga(shape=a, rate=b)}$, the rate
  parameter for $\sigma^2$, the variance for each batch and component.  

Constructing an instance of class `Hyperparameters` for a `MarginalModel` can
be performed as follows.
```{r Hyperparameters}
hypp <- Hyperparameters(type="marginal", k=3)
```

- graphical model

### simulateData

CNPBayes also allows for the simulation of test data. The number of
observations, means for each component, standard deviations for each component,
and mixture proportions must be specified. 
```{r simulateData}
sim.data <- simulateData(N=2500, p=rep(1/3, 3),
                         theta=c(-1, 0, 1),
                         sds=rep(0.1, 3))
```

### posteriorSimulation

To simulate the posterior distribution, an instance of class MarginalModel or
must first be constructed. Note that when initializing objects of these 
classes, the parameters `data`, `k` (number of *a priori* components), 
`hypp`, (object of class `Hyperparameters`) and `mcmc.params` (object of class
`McmcParams`) should be specified. Default values for `hypp` and `mcmc.params`
will be used if not specified. Note that to retrieve the simulated data from
the object, the `y` method can be used. After construction of a model, the
`posteriorSimulation` method should be used.

```{r model}
model <- MarginalModel(data=y(sim.data), k=3,
                       hypp=hypp.marginal,
                       mcmc.params=mp)

model <- posteriorSimulation(model)
```

The results of a `DensityModel` call returns an object of class
`DensityModel`. This object can be used, along with the data, for plotting.

```{r plot}
plot(DensityModel(model), y(sim.data), 
     main="Marginal Model posterior")
```

## BatchModel
### McmcParams

In order to simulate the posterior distribution of a model, many parameters for
the routine must be specified first. An instance of class `McmcParams` is used
to specify the simulation options, such as number of iterations, length of
burnin, and thinning interval.
```{r McmcParams-batch}
mp <- McmcParams(iter=1000,
                 burnin=100,
                 thin=1)
```

### Hyperparameters

Hyperparameters for the mixture model are specified as an instance of class
`Hyperparameters`. Hyperparameters include:  

- `k` the number of components (or copy numbers). Defaults to 2.  
- `mu.0` and `tau2.0` priors for $\mu \sim \text{N(mu.0, tau2.0)}$, the 
  overall mean of components. Default to 0 and 100 respectively.  
- `eta.0` and `m2.0` priors for 
  $\tau^2 \sim \text{Ga(rate=eta.0, shape=m2.0)}$, the overall variance across
  components. Default to 1 and 0.1 respectively for marginal models and 1800
  and 1/60 respectively for batch models.  
- `alpha` the prior mixture probabilities. Does not have to sum to 1. By
  default, a noninformative prior of equal mixtures is used.  
- `beta` prior for $\nu_0$. Defaults to 0.1.  
- `a` and `b` priors for $\sigma^2_0 \sim \text{Ga(shape=a, rate=b)}$, the rate
  parameter for $\sigma^2$, the variance for each batch and component.  

Constructing an instance of class `Hyperparameters` for a `BatchModel` can
be performed as follows. 
```{r Hyperparameters-batch}
hypp <- Hyperparameters(type="batch", k=3)
```

- graphical model

### simulateData

CNPBayes also allows for the simulation of test data. The number of
observations, means for each component, standard deviations for each component,
and mixture proportions must be specified. The batch label for each observation
must be specified as well.
```{r simulateData-batch}
k <- 3
nbatch <- 3
means <- matrix(c(-1.2, -1.0, -0.8,
                -0.2, 0, 0.2,
                0.8, 1, 1.2), nbatch, k, byrow=FALSE)
sds <- matrix(0.1, nbatch, k)
N <- 1500
sim.data <- simulateBatchData(N=N,
                              batch=rep(letters[1:3], length.out=N),
                              theta=means,
                              sds=sds,
                              p=c(1/5, 1/3, 1-1/3-1/5))
```

### posteriorSimulation

To simulate the posterior distribution, an instance of class `BatchModel` 
must first be constructed. Note that when initializing objects of these 
classes, the parameters `data`, `k` (number of *a priori* components), 
`hypp`, (object of class `Hyperparameters`) and `mcmc.params` (object of class
`McmcParams`) should be specified. Additionally, a vector of batch labels 
should be passed to the `batch` parameter.  Default values for `hypp` and 
`mcmc.params` will be used if not specified. Note that to retrieve the 
simulated data from the object, the `y` method can be used. After construction 
of a model, the `posteriorSimulation` method should be used.

```{r model-batch}
model <- BatchModel(data=y(sim.data), k=3,
                    batch=rep(letters[1:3], length.out=N),
                    hypp=hypp,
                    mcmc.params=mp)

model <- posteriorSimulation(model)
```

- merging (if needed)

# K unknown

Often times, the number of components is not known $a priori$. In order to
estimate the number, the `computeMarginalLik` function is used. 

```{r computeMarginalLik}
x <- computeMarginalLik(y(sim.data), K=2:3)
orderModels(x)
```

- computeMarginalLik
    - Ref Chib estimator / Berkhof for estimating marginal likelihoods
- computing a bayes factor
- merging components
- Alternative statistics for model selection (i.e., BIC)

# Other applications
- down-sampling 
- modeling differences in variance (same mean)
   - paramUpdates




